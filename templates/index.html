<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ERAI - WUG Secure System (Enhanced + SFX)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        window.MathJax = { 
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true, packages: {'[+]': ['mhchem']} }, 
            loader: {load: ['[tex]/mhchem']} 
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* Base Styling & Animations (Tetap Sesuai Request Kakak) */
        @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes bounceIn { 0% { opacity: 0; transform: translateY(20px) scale(0.9); } 60% { opacity: 1; transform: translateY(-5px) scale(1.05); } 100% { transform: translateY(0) scale(1); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes alarmFlash { 0% { box-shadow: inset 0 0 0px red; } 50% { box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.3); } 100% { box-shadow: inset 0 0 0px red; } }
        
        .security-alert { animation: alarmFlash 0.5s ease-in-out 3; }
        body {
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #a8edea, #fed6e3, #d291ff, #84fab0);
            background-size: 400% 400%; animation: gradientMove 15s ease infinite;
            height: 100vh; height: 100dvh; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative;
        }

        /* WUG SECURE ANTI-SS UI */
        body.blur-mode .app-container { filter: blur(25px); transition: filter 0.1s ease-out; }
        #wug-watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 2.5rem; color: rgba(0,0,0,0.03); pointer-events: none; z-index: 9999; font-weight: 900; text-transform: uppercase;
        }
        body:not(.pencarian-active) { user-select: none; -webkit-user-select: none; }
        body.pencarian-active { user-select: text !important; -webkit-user-select: text !important; }

        .shape { position: absolute; background: rgba(255, 255, 255, 0.1); border-radius: 50%; filter: blur(50px); opacity: 0.5; }
        .shape-1 { width: 200px; height: 200px; top: 10%; left: 15%; }
        .shape-2 { width: 150px; height: 150px; bottom: 5%; right: 10%; background: rgba(231, 92, 186, 0.15); }

        .app-container {
            width: 95%; max-width: 850px; height: 90vh; height: 90dvh;
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 24px;
            display: flex; flex-direction: column; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; position: relative;
        }

        header { padding: 15px 20px; background: rgba(255, 255, 255, 0.3); border-bottom: 1px solid rgba(255, 255, 255, 0.3); }
        .mode-selector { display: flex; gap: 5px; justify-content: center; margin-top: 10px; }
        .mode-selector button {
            background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 8px 12px; border-radius: 15px; cursor: pointer; font-size: 0.75rem; font-weight: 700; flex: 1; transition: 0.3s;
        }
        .mode-selector button.active { background: #6c5ce7; color: white; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }

        #chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .bubble { max-width: 85%; padding: 12px 18px; border-radius: 20px; font-size: 0.95rem; line-height: 1.6; animation: bounceIn 0.4s ease-out; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .user-row { display: flex; justify-content: flex-end; }
        .user-bubble { background: white; border-bottom-right-radius: 4px; }
        .erai-row { display: flex; justify-content: flex-start; }
        .erai-bubble { background: rgba(108, 92, 231, 0.1); border: 1px solid rgba(108, 92, 231, 0.2); border-bottom-left-radius: 4px; }

        .copy-btn { position: absolute; bottom: 5px; right: 10px; background: rgba(108, 92, 231, 0.2); border: none; border-radius: 8px; padding: 3px 8px; font-size: 0.6rem; cursor: pointer; display: none; }
        body.pencarian-active .copy-btn { display: block; }

        .input-box { padding: 15px; display: flex; gap: 10px; background: rgba(255, 255, 255, 0.3); border-top: 1px solid rgba(255, 255, 255, 0.3); align-items: center; }
        input[type="text"] { flex: 1; padding: 12px 20px; border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.8); outline: none; background: rgba(255, 255, 255, 0.6); }
        .send-btn { background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: 700; cursor: pointer; }

        #loading-overlay { position: absolute; inset: 0; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; visibility: hidden; z-index: 99; transition: 0.3s; }
        #loading-overlay.active { opacity: 1; visibility: visible; }
        .spinner { border: 4px solid rgba(108, 92, 231, 0.3); border-top: 4px solid #6c5ce7; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .wug-toast { background: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 10px; transform: translateX(120%); transition: 0.4s; display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 0.85rem; }
        .wug-toast.show { transform: translateX(0); }

        @media (max-width: 600px) { .app-container { width: 100%; height: 100vh; border-radius: 0; } }
    </style>
</head>
<body>

<div id="wug-watermark">WUG SECURITY SYSTEM</div>
<div id="toast-container"></div>
<div class="shape shape-1"></div><div class="shape shape-2"></div>

<div class="app-container" id="main-container">
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text">ERAI sedang memproses...</p>
    </div>

    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: 800; color: #444;">ðŸ¤– ERAI | WUG SECURE</div>
            <div style="font-size: 0.65rem; opacity: 0.5;">v2.6 WUG Standard</div>
        </div>
        <div class="mode-selector">
            <button onclick="setMode('belajar')" id="btn-belajar" class="active">Mode Belajar</button>
            <button onclick="setMode('latihan')" id="btn-latihan">Mode Latihan</button>
            <button onclick="setMode('pencarian')" id="id-btn-pencarian">Mode Pencarian</button>
        </div>
    </header>

    <div id="chat-area"></div>

    <div class="input-box">
        <input type="file" id="fileInput" style="display:none" onchange="handleFile(this)">
        <button onclick="document.getElementById('fileInput').click()" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">ðŸ“¸</button>
        <input type="text" id="userInput" placeholder="Tulis pesan ke ERAI..." autocomplete="off">
        <button class="send-btn" onclick="handleSend()">Kirim</button>
    </div>
</div>

<script>
    let currentMode = "belajar";
    let isSending = false;
    let chatHistory = [];

    const sfx = {
        send: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3'),
        receive: new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3'),
        error: new Audio('https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3')
    };

    function playSfx(name) { 
        if(sfx[name]) { sfx[name].currentTime = 0; sfx[name].play().catch(() => {}); } 
    }

    // --- SECURITY LOGIC ---
    window.addEventListener('blur', () => document.body.classList.add('blur-mode'));
    window.addEventListener('focus', () => document.body.classList.remove('blur-mode'));

    document.addEventListener('keydown', (e) => {
        if (currentMode === 'pencarian') return;
        if (e.key === "F12" || (e.ctrlKey && (e.key === 'u' || e.key === 's' || e.key === 'i'))) {
            e.preventDefault();
            playSfx('error');
            showWugToast("Akses Dibatasi WUG Secure!", "ðŸ›¡ï¸");
        }
    });

    document.addEventListener('contextmenu', (e) => {
        if (currentMode !== 'pencarian') { e.preventDefault(); showWugToast("Klik kanan dilarang!", "ðŸš«"); }
    });

    // --- UI LOGIC ---
    function showWugToast(msg, icon = 'ðŸš€') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'wug-toast';
        toast.innerHTML = `<span>${icon}</span> ${msg}`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 50);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 3000);
    }

    function setMode(mode) {
        if (isSending) return;
        currentMode = mode;
        document.querySelectorAll('.mode-selector button').forEach(btn => btn.classList.remove('active'));
        const activeBtn = (mode === 'pencarian') ? document.getElementById('id-btn-pencarian') : document.getElementById(`btn-${mode}`);
        if(activeBtn) activeBtn.classList.add('active');
        document.body.className = (mode === 'pencarian') ? 'pencarian-active' : '';
        showWugToast(`Mode ${mode.toUpperCase()} Aktif`);
    }

    function showLoadingOverlay(active) {
        document.getElementById('loading-overlay').classList.toggle('active', active);
    }

    // --- MESSAGE LOGIC (FIXED) ---
    function displayMessage(role, text) {
        const chatArea = document.getElementById('chat-area');
        const row = document.createElement('div');
        row.className = role === 'user' ? 'user-row' : 'erai-row';
        
        let cleanText = text.replace(/\\\[/g, '$$').replace(/\\\]/g, '$$');
        let htmlContent = marked.parse(cleanText);
        
        row.innerHTML = `
            <div class="bubble ${role}-bubble">
                <div class="tex2jax_process">${htmlContent}</div>
                ${role === 'erai' ? `<button class="copy-btn" onclick="navigator.clipboard.writeText(\`${text.replace(/`/g, '\\`')}\`); showWugToast('Disalin!', 'ðŸ“‹')">Salin</button>` : ''}
            </div>`;
        
        chatArea.appendChild(row);
        if (window.MathJax) MathJax.typesetPromise([row]);
        chatArea.scrollTop = chatArea.scrollHeight;
        playSfx(role === 'user' ? 'send' : 'receive');
    }

    async function handleSend() {
        const input = document.getElementById('userInput');
        const message = input.value.trim();
        if (!message || isSending) return;

        isSending = true;
        displayMessage('user', message);
        input.value = '';
        showLoadingOverlay(true);

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, mode: currentMode, history: chatHistory })
            });
            const data = await response.json();
            
            showLoadingOverlay(false);
            displayMessage('erai', data.response);

            chatHistory.push({ role: "user", content: message });
            chatHistory.push({ role: "assistant", content: data.response });
        } catch (e) {
            showLoadingOverlay(false);
            displayMessage('erai', "**[ERROR]** Koneksi WUG terputus.");
        } finally {
            isSending = false;
        }
    }

    document.getElementById("userInput").addEventListener("keypress", (e) => { if (e.key === "Enter") handleSend(); });

    window.onload = () => { displayMessage('erai', "Halo **Admin**! ERAI siap membantu. Pilih mode di atas ya!"); };
</script>
</body>
</html>
